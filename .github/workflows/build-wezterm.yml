name: Build WezTerm for Termux

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout WezTerm
      uses: actions/checkout@v4
      with:
        repository: wez/wezterm
        submodules: recursive
    
    - name: Set up QEMU
      run: |
        docker run --rm --privileged tonistiigi/binfmt --install all
    
    - name: Fix workspace permissions
      run: |
        sudo chmod -R 777 ${{ github.workspace }}
    
    - name: Cache Cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: termux-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          termux-cargo-
    
    - name: Build in Termux container
      run: |
        docker run --rm \
          --privileged \
          --platform linux/arm64 \
          --dns 8.8.8.8 \
          --dns 1.1.1.1 \
          -v ${{ github.workspace }}:/workspace \
          -v $HOME/.cargo:/root/.cargo \
          -w /workspace \
          termux/termux-docker:aarch64 \
          bash -c "
            yes | pkg upgrade -y && \
            pkg install -y x11-repo && \
            pkg install -y rust git binutils cmake openssl fontconfig freetype harfbuzz libxcb xcb-util-image xcb-util-keysyms xcb-util-wm libxkbcommon python zlib libx11 xorgproto && \
            cargo build --release --no-default-features --features vendored-fonts
          "
    
    - name: Fix permissions for upload
      run: |
        sudo chmod -R 755 ${{ github.workspace }}/target/release
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wezterm-build-output
        path: target/release/wezterm
        retention-days: 7

  package:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Download build output
      uses: actions/download-artifact@v4
      with:
        name: wezterm-build-output
    
    - name: Verify binary
      run: |
        ls -lah
        file wezterm || true
    
    - name: Upload final binary
      uses: actions/upload-artifact@v4
      with:
        name: wezterm-termux-aarch64
        path: wezterm
