name: Build WezTerm for Termux

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout WezTerm
      uses: actions/checkout@v4
      with:
        repository: wez/wezterm
        submodules: recursive
    
    - name: Set up QEMU
      run: |
        docker run --rm --privileged tonistiigi/binfmt --install all
    
    - name: Fix workspace permissions
      run: |
        sudo chmod -R 777 ${{ github.workspace }}
    
    - name: Build in Termux container
      run: |
        docker run --rm \
          --privileged \
          --platform linux/arm64 \
          --dns 8.8.8.8 \
          --dns 1.1.1.1 \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          termux/termux-docker:aarch64 \
          bash -c "
            yes | pkg upgrade -y && \
            pkg install -y x11-repo && \
            pkg install -y rust git binutils cmake openssl fontconfig freetype harfbuzz libxcb xcb-util-image xcb-util-keysyms xcb-util-wm libxkbcommon python zlib && \
            cargo build --release -j 2
          "
    
    - name: Fix artifact permissions
      run: |
        sudo chmod -R 755 ${{ github.workspace }}/target
    
    - name: Upload binary
      uses: actions/upload-artifact@v4
      with:
        name: wezterm-termux-aarch64
        path: target/release/wezterm
