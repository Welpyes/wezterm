on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout WezTerm
      uses: actions/checkout@v4
      with:
        repository: wez/wezterm
        submodules: recursive
    
    - name: Set up QEMU with binfmt
      run: |
        docker run --rm --privileged tonistiigi/binfmt --install all
    
    - name: Verify QEMU setup
      run: |
        docker run --rm --platform linux/arm64 arm64v8/ubuntu uname -m
    
    - name: Build in Termux container
      run: |
        docker run --rm \
          --platform linux/arm64 \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          termux/termux-docker:aarch64 \
          bash -c "
            pkg update && \
            pkg install -y rust git binutils cmake openssl fontconfig freetype harfbuzz libxcb xcb-util-image xcb-util-keysyms xcb-util-wm libxkbcommon python zlib && \
            cargo build --release -j 2
          "
    
    - name: Upload binary
      uses: actions/upload-artifact@v4
      with:
        name: wezterm-termux-aarch64
        path: target/release/wezterm
